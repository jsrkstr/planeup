/**
 * KineticJS JavaScript Library v3.7.3
 * http://www.kineticjs.com/
 * Copyright 2012, Eric Rowell
 * Licensed under the MIT or GPL Version 2 licenses.
 * Date: Feb 12 2012
 *
 * Copyright (C) 2011 - 2012 by Eric Rowell
 *
 * Permission is hereby granted, free of charge, to any person obtaining a copy
 * of this software and associated documentation files (the "Software"), to deal
 * in the Software without restriction, including without limitation the rights
 * to use, copy, modify, merge, publish, distribute, sublicense, and/or sell
 * copies of the Software, and to permit persons to whom the Software is
 * furnished to do so, subject to the following conditions:
 *
 * The above copyright notice and this permission notice shall be included in
 * all copies or substantial portions of the Software.
 *
 * THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR
 * IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,
 * FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT. IN NO EVENT SHALL THE
 * AUTHORS OR COPYRIGHT HOLDERS BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER
 * LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING FROM,
 * OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS IN
 * THE SOFTWARE.
 */
var Kinetic={};Kinetic.GlobalObject={stages:[],idCounter:0,extend:function(c,b){for(var a in b.prototype){c.prototype[a]=b.prototype[a]}}};Kinetic.Node=function(a){this.visible=true;this.isListening=true;this.name=a;this.x=0;this.y=0;this.scale={x:1,y:1};this.rotation=0;this.eventListeners={};this.drag={x:false,y:false};this.alpha=1};Kinetic.Node.prototype={on:function(c,i){var g=c.split(" ");for(var d=0;d<g.length;d++){var h=g[d];var b=(h.indexOf("touch")==-1)?"on"+h:h;var f=b.split(".");var e=f[0];var a=f.length>1?f[1]:"";if(!this.eventListeners[e]){this.eventListeners[e]=[]}this.eventListeners[e].push({name:a,handler:i})}},off:function(b){var h=b.split(" ");for(var d=0;d<h.length;d++){var j=h[d];var a=(j.indexOf("touch")==-1)?"on"+j:j;var f=a.split(".");var e=f[0];if(this.eventListeners[e]&&f.length>1){var c=f[1];for(var g=0;g<this.eventListeners[e].length;g++){if(this.eventListeners[e][g].name==c){this.eventListeners[e].splice(g,1);if(this.eventListeners[e].length===0){this.eventListeners[e]=undefined}break}}}else{this.eventListeners[e]=undefined}}},show:function(){this.visible=true},hide:function(){this.visible=false},getZIndex:function(){return this.index},setScale:function(b,a){if(a){this.scale.x=b;this.scale.y=a}else{this.scale.x=b;this.scale.y=b}},setPosition:function(a,b){this.x=a;this.y=b},getPosition:function(){return{x:this.x,y:this.y}},getAbsolutePosition:function(){var a=this.x;var c=this.y;var b=this.getParent();while(b.className!=="Stage"){a+=b.x;c+=b.y;b=b.parent}return{x:a,y:c}},move:function(a,b){this.x+=a;this.y+=b},setRotation:function(a){this.rotation=a},rotate:function(a){this.rotation+=a},listen:function(a){this.isListening=a},moveToTop:function(){var a=this.index;this.parent.children.splice(a,1);this.parent.children.push(this);this.parent._setChildrenIndices()},moveUp:function(){var a=this.index;this.parent.children.splice(a,1);this.parent.children.splice(a+1,0,this);this.parent._setChildrenIndices()},moveDown:function(){var a=this.index;if(a>0){this.parent.children.splice(a,1);this.parent.children.splice(a-1,0,this);this.parent._setChildrenIndices()}},moveToBottom:function(){var a=this.index;this.parent.children.splice(a,1);this.parent.children.unshift(this);this.parent._setChildrenIndices()},setZIndex:function(b){var a=this.index;this.parent.children.splice(a,1);this.parent.children.splice(b,0,this);this.parent._setChildrenIndices()},setAlpha:function(a){this.alpha=a},getAlpha:function(){return this.alpha},_initDrag:function(){var b=this;var a=["mousedown","touchstart"];for(var d=0;d<a.length;d++){var c=a[d];(function(){var e=c;b.on(e+".initdrag",function(f){var g=b.getStage();var h=g.getUserPosition();if(h){g.nodeDragging=b;g.nodeDragging.offset={};g.nodeDragging.offset.x=h.x-b.x;g.nodeDragging.offset.y=h.y-b.y;b._handleEvents("ondragstart",f)}})})()}},_dragCleanup:function(){if(!this.drag.x&&!this.drag.y){this.off("mousedown.initdrag");this.off("touchstart.initdrag")}},draggable:function(b){if(b){var a=!this.drag.x&&!this.drag.y;this.drag={x:true,y:true};if(a){this._initDrag()}}else{this.drag={x:false,y:false};this._dragCleanup()}},draggableX:function(b){if(b){var a=!this.drag.x&&!this.drag.y;this.drag.x=true;if(a){this._initDrag()}}else{this.drag.x=false;this._dragCleanup()}},draggableY:function(b){if(b){var a=!this.drag.x&&!this.drag.y;this.drag.y=true;if(a){this._initDrag()}}else{this.drag.y=false;this._dragCleanup()}},_handleEvents:function(b,a){function c(g){var f=g.eventListeners;if(f[b]){var e=f[b];for(var d=0;d<e.length;d++){e[d].handler.apply(g,[a])}}if(g.parent.className!=="Stage"){c(g.parent)}}c(this)},moveTo:function(b){var a=this.parent;a.children.splice(this.index,1);a._setChildrenIndices();b.children.push(this);this.index=b.children.length-1;this.parent=b;b._setChildrenIndices();if(this.name){a.childrenNames[this.name]=undefined;b.childrenNames[this.name]=this}},getParent:function(){return this.parent},getLayer:function(){if(this.className=="Layer"){return this}else{return this.getParent().getLayer()}},getStage:function(){return this.getParent().getStage()},getName:function(){return this.name}};Kinetic.Container=function(){this.children=[];this.childrenNames={}};Kinetic.Container.prototype={_setChildrenIndices:function(){for(var a=0;a<this.children.length;a++){this.children[a].index=a}},_drawChildren:function(){var a=this.children;for(var c=0;c<a.length;c++){var b=a[c];if(b.className=="Shape"){b._draw(b.getLayer())}else{b._draw()}}},getChildren:function(){return this.children},getChild:function(a){return this.childrenNames[a]},_add:function(a){if(a.name){this.childrenNames[a.name]=a}a.id=Kinetic.GlobalObject.idCounter++;a.index=this.children.length;a.parent=this;this.children.push(a)},_remove:function(a){if(a.name!==undefined){this.childrenNames[a.name]=undefined}this.children.splice(a.index,1);this._setChildrenIndices();a=undefined}};Kinetic.Stage=function(b,c,a){this.className="Stage";this.container=typeof b=="string"?document.getElementById(b):b;this.width=c;this.height=a;this.scale={x:1,y:1};this.dblClickWindow=400;this.targetShape={};this.clickStart=false;this.mousePos;this.mouseDown=false;this.mouseUp=false;this.touchPos;this.touchStart=false;this.touchEnd=false;this.bufferLayer=new Kinetic.Layer();this.backstageLayer=new Kinetic.Layer();this.bufferLayer.parent=this;this.backstageLayer.parent=this;var e=this.backstageLayer;this._stripLayer(e);this.bufferLayer.getCanvas().style.display="none";this.backstageLayer.getCanvas().style.display="none";this.bufferLayer.canvas.width=this.width;this.bufferLayer.canvas.height=this.height;this.container.appendChild(this.bufferLayer.canvas);this.backstageLayer.canvas.width=this.width;this.backstageLayer.canvas.height=this.height;this.container.appendChild(this.backstageLayer.canvas);this._listen();this._prepareDrag();var d=Kinetic.GlobalObject.stages;d.push(this);this.id=Kinetic.GlobalObject.idCounter++;Kinetic.Container.apply(this,[])};Kinetic.Stage.prototype={draw:function(){this._drawChildren()},_stripLayer:function(a){a.context.stroke=function(){};a.context.fill=function(){};a.context.fillRect=function(c,e,d,b){a.context.rect(c,e,d,b)};a.context.strokeRect=function(c,e,d,b){a.context.rect(c,e,d,b)};a.context.drawImage=function(){};a.context.fillText=function(){};a.context.strokeText=function(){}},_prepareDrag:function(){var b=this;this.on("mouseout",function(e){if(b.nodeDragging){b.nodeDragging._handleEvents("ondragend",e)}b.nodeDragging=undefined},false);var a=[{end:"mouseup",move:"mousemove"},{end:"touchend",move:"touchmove"}];for(var d=0;d<a.length;d++){var c=a[d];(function(){var e=c;b.on(e.move,function(f){if(b.nodeDragging){var g=e.move=="mousemove"?b.getMousePosition():b.getTouchPosition();if(b.nodeDragging.drag.x){b.nodeDragging.x=g.x-b.nodeDragging.offset.x}if(b.nodeDragging.drag.y){b.nodeDragging.y=g.y-b.nodeDragging.offset.y}b.nodeDragging.getLayer().draw();b.nodeDragging._handleEvents("ondragmove",f)}},false);b.on(e.end,function(f){if(b.nodeDragging){b.nodeDragging._handleEvents("ondragend",f)}b.nodeDragging=undefined})})()}this.on("touchend",function(e){if(b.nodeDragging){b.nodeDragging._handleEvents("ondragend",e)}b.nodeDragging=undefined})},setSize:function(c,a){var d=this.children;for(n=0;n<d.length;n++){var b=d[n];b.getCanvas().width=c;b.getCanvas().height=a;b.draw()}this.width=c;this.height=a;this.bufferLayer.getCanvas().width=c;this.bufferLayer.getCanvas().height=a;this.backstageLayer.getCanvas().width=c;this.backstageLayer.getCanvas().height=a},setScale:function(h,f){var j=this.scale.x;var g=this.scale.y;if(f){this.scale.x=h;this.scale.y=f}else{this.scale.x=h;this.scale.y=h}var d=this.children;for(var c=0;c<d.length;c++){var b=d[c].children;while(b){for(var e=0;e<b.length;e++){var a=b[e];a.x*=this.scale.x/j;a.y*=this.scale.y/g}b=a.children}}},clear:function(){var a=this.children;for(var b=0;b<a.length;b++){a[b].clear()}},toDataURL:function(e){var b=this.bufferLayer;var a=b.getContext();var d=this.children;function c(h){var g=d[h].getCanvas().toDataURL();var f=new Image();f.onload=function(){a.drawImage(this,0,0);h++;if(h<d.length){c(h)}else{e(b.getCanvas().toDataURL())}};f.src=g}b.clear();c(0)},remove:function(a){this._remove(a);this.container.removeChild(a.canvas)},on:function(b,a){this.container.addEventListener(b,a)},add:function(a){if(a.name){this.childrenNames[a.name]=a}a.canvas.width=this.width;a.canvas.height=this.height;this._add(a);a.draw();this.container.appendChild(a.canvas)},_handleEvent:function(i){if(!i){i=window.event}this._setMousePosition(i);this._setTouchPosition(i);var c=this.backstageLayer;var f=c.getContext();var g=this;c.clear();var h=0;function d(j){j._draw(c);var p=g.getUserPosition();var o=j.eventListeners;if(j.visible&&p!==undefined&&f.isPointInPath(p.x,p.y)){if(g.mouseDown){g.mouseDown=false;g.clickStart=true;j._handleEvents("onmousedown",i);return true}else{if(g.mouseUp){g.mouseUp=false;j._handleEvents("onmouseup",i);if(g.clickStart){j._handleEvents("onclick",i);if(j.inDoubleClickWindow){j._handleEvents("ondblclick",i)}j.inDoubleClickWindow=true;setTimeout(function(){j.inDoubleClickWindow=false},g.dblClickWindow)}return true}else{if(g.touchStart){g.touchStart=false;j._handleEvents("touchstart",i);if(o.ondbltap&&j.inDoubleClickWindow){var m=o.ondbltap;for(var l=0;l<m.length;l++){m[l].handler.apply(j,[i])}}j.inDoubleClickWindow=true;setTimeout(function(){j.inDoubleClickWindow=false},g.dblClickWindow);return true}else{if(g.touchEnd){g.touchEnd=false;j._handleEvents("touchend",i);return true}else{if(o.touchmove){j._handleEvents("touchmove",i);return true}else{if(g.targetShape.id===undefined||(g.targetShape.id!=j.id&&g.targetShape.getZIndex()<j.getZIndex())){var k=g.targetShape.eventListeners;if(k){g.targetShape._handleEvents("onmouseout",i)}g.targetShape=j;j._handleEvents("onmouseover",i);return true}else{j._handleEvents("onmousemove",i);return true}}}}}}}else{if(g.targetShape.id==j.id){g.targetShape={};j._handleEvents("onmouseout",i);return true}}return false}function b(m){var l=m.children;for(var k=l.length-1;k>=0;k--){h++;var o=l[k];if(o.className=="Shape"){var j=d(o);if(j){return true}}else{b(o)}}return false}for(var a=this.children.length-1;a>=0;a--){var e=this.children[a];if(e.visible&&a>=0&&e.isListening){if(b(e)){a=-1}}}},_listen:function(){var a=this;this.container.addEventListener("mousedown",function(b){a.mouseDown=true;a._handleEvent(b)},false);this.container.addEventListener("mousemove",function(b){a.mouseUp=false;a.mouseDown=false;a._handleEvent(b)},false);this.container.addEventListener("mouseup",function(b){a.mouseUp=true;a.mouseDown=false;a._handleEvent(b);a.clickStart=false},false);this.container.addEventListener("mouseover",function(b){a._handleEvent(b)},false);this.container.addEventListener("mouseout",function(b){a.mousePos=undefined},false);this.container.addEventListener("touchstart",function(b){b.preventDefault();a.touchStart=true;a._handleEvent(b)},false);this.container.addEventListener("touchmove",function(b){b.preventDefault();a._handleEvent(b)},false);this.container.addEventListener("touchend",function(b){b.preventDefault();a.touchEnd=true;a._handleEvent(b)},false)},getMousePosition:function(a){return this.mousePos},getTouchPosition:function(a){return this.touchPos},getUserPosition:function(a){return this.getTouchPosition()||this.getMousePosition()},_setMousePosition:function(a){var c=a.clientX-this._getContainerPosition().left+window.pageXOffset;var b=a.clientY-this._getContainerPosition().top+window.pageYOffset;this.mousePos={x:c,y:b}},_setTouchPosition:function(c){if(c.touches!==undefined&&c.touches.length==1){var d=c.touches[0];var b=d.clientX-this._getContainerPosition().left+window.pageXOffset;var a=d.clientY-this._getContainerPosition().top+window.pageYOffset;this.touchPos={x:b,y:a}}},_getContainerPosition:function(){var c=this.container;var b=0;var a=0;while(c&&c.tagName!="BODY"){b+=c.offsetTop;a+=c.offsetLeft;c=c.offsetParent}return{top:b,left:a}},getContainer:function(){return this.container},getStage:function(){return this}};Kinetic.GlobalObject.extend(Kinetic.Stage,Kinetic.Container);Kinetic.Layer=function(a){this.className="Layer";this.canvas=document.createElement("canvas");this.context=this.canvas.getContext("2d");this.canvas.style.position="absolute";Kinetic.Container.apply(this,[]);Kinetic.Node.apply(this,[a])};Kinetic.Layer.prototype={draw:function(){this._draw()},_draw:function(){this.clear();if(this.visible){this._drawChildren()}},clear:function(){var b=this.getContext();var a=this.getCanvas();b.clearRect(0,0,a.width,a.height)},getCanvas:function(){return this.canvas},getContext:function(){return this.context},add:function(a){this._add(a)},remove:function(a){this._remove(a)}};Kinetic.GlobalObject.extend(Kinetic.Layer,Kinetic.Container);Kinetic.GlobalObject.extend(Kinetic.Layer,Kinetic.Node);Kinetic.Group=function(a){this.className="Group";Kinetic.Container.apply(this,[]);Kinetic.Node.apply(this,[a])};Kinetic.Group.prototype={_draw:function(){if(this.visible){this._drawChildren()}},add:function(a){this._add(a)},remove:function(a){this._remove(a)}};Kinetic.GlobalObject.extend(Kinetic.Group,Kinetic.Container);Kinetic.GlobalObject.extend(Kinetic.Group,Kinetic.Node);Kinetic.Shape=function(b,a){this.className="Shape";this.drawFunc=b;Kinetic.Node.apply(this,[a])};Kinetic.Shape.prototype={getContext:function(){return this.tempLayer.getContext()},getCanvas:function(){return this.tempLayer.getCanvas()},_draw:function(c){if(this.visible){var a=c.getStage();var b=c.getContext();var e=[];e.unshift(this);var d=this.parent;while(d.className!=="Stage"){e.unshift(d);d=d.parent}for(var g=0;g<e.length;g++){var f=e[g];b.save();if(f.x!==0||f.y!==0){b.translate(f.x,f.y)}if(f.rotation!==0){b.rotate(f.rotation)}if(f.scale.x!==1||f.scale.y!==1){b.scale(f.scale.x,f.scale.y)}if(f.alpha!==1){b.globalAlpha=f.alpha}}b.save();if(a&&(a.scale.x!=1||a.scale.y!=1)){b.scale(a.scale.x,a.scale.y)}this.tempLayer=c;this.drawFunc.call(this);for(var g=0;g<e.length;g++){b.restore()}b.restore()}}};Kinetic.GlobalObject.extend(Kinetic.Shape,Kinetic.Node);